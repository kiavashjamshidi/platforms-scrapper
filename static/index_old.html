<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* Top Filters Bar */
        .top-filters {
            background: #2f3542;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none; /* Hidden by default, shown when needed */
        }
        
        .top-filters.show {
            display: block;
        }
        
        .filters-container {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-item label {
            font-size: 12px;
            color: #a4b0be;
            font-weight: 500;
        }
        
        .filter-item select,
        .filter-item input {
            padding: 8px 12px;
            border: 1px solid #57606f;
            border-radius: 4px;
            background: #3d4454;
            color: white;
            font-size: 14px;
            min-width: 120px;
        }
        
        .filter-item input[type="text"] {
            min-width: 200px;
        }
        
        .refresh-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #ee5a52;
        }
        
        /* Main Layout */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #2f3542;
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar h2 {
            color: #ff6b6b;
            margin-bottom: 30px;
            text-align: center;
            font-size: 20px;
        }
        
        .nav-section {
            margin-bottom: 30px;
        }
        
        .nav-section h3 {
            color: #a4b0be;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }
        
        .nav-button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            background: #3742fa;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 10px;
            font-size: 14px;
            transition: all 0.3s;
            text-align: left;
        }
        
        .nav-button:hover {
            background: #5352ed;
            transform: translateX(5px);
        }
        
        .nav-button.active {
            background: #ff6b6b;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #2f3542;
            margin-bottom: 10px;
        }
        
        .breadcrumb {
            color: #57606f;
            font-size: 14px;
        }
        
        .content-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .section-header {
            background: #f1f2f6;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .section-title {
            font-size: 18px;
            color: #2f3542;
            margin: 0;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #57606f;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2f3542;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .data-table th:hover {
            background: #e9ecef;
        }
        
        .data-table th.sortable::after {
            content: 'â†•';
            position: absolute;
            right: 5px;
            opacity: 0.5;
        }
        
        .data-table th.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
        }
        
        .data-table th.sort-desc::after {
            content: 'â†“';
            opacity: 1;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .platform-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .platform-kick {
            background: #53d769;
            color: white;
        }
        
        .platform-twitch {
            background: #9146ff;
            color: white;
        }
        
        .viewer-count {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .follower-count {
            color: #3498db;
            font-weight: bold;
        }
        
        .stream-link {
            color: #3742fa;
            text-decoration: none;
        }
        
        .stream-link:hover {
            text-decoration: underline;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #57606f;
        }
        
        /* Channel History Styles */
        .history-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2f3542;
        }
        
        .stat-label {
            font-size: 12px;
            color: #57606f;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .chart-container {
            padding: 20px;
            height: 400px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .main-content {
                padding: 10px;
            }
            
            .filters-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-item {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
            
            .filter-item label {
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- Top Filters Bar -->
    <div id="topFilters" class="top-filters">
        <div class="filters-container">
            <!-- Platform Filter - Always visible -->
            <div class="filter-item">
                <label>Platform</label>
                <select id="platformFilter">
                    <option value="kick">Kick</option>
                    <option value="twitch">Twitch</option>
                </select>
            </div>
            
            <!-- Limit Filter - For data lists -->
            <div class="filter-item" id="limitFilterItem">
                <label>Limit</label>
                <select id="limitFilter">
                    <option value="10">10 results</option>
                    <option value="25">25 results</option>
                    <option value="50">50 results</option>
                    <option value="100">100 results</option>
                </select>
            </div>
            
            <!-- Sort Filter - For sortable data -->
            <div class="filter-item" id="sortFilterItem">
                <label>Sort By</label>
                <select id="sortFilter">
                    <option value="viewers">Viewers</option>
                    <option value="followers">Followers</option>
                </select>
            </div>
            
            <!-- Search Filter - For search section -->
            <div class="filter-item" id="searchFilterItem" style="display: none;">
                <label>Search Query</label>
                <input type="text" id="searchQuery" placeholder="Enter search term...">
            </div>
            
            <!-- Channel Filter - For channel history -->
            <div class="filter-item" id="channelFilterItem" style="display: none;">
                <label>Channel ID/Username</label>
                <input type="text" id="channelInput" placeholder="Enter channel...">
            </div>
            
            <!-- Time Window Filter - For historical data -->
            <div class="filter-item" id="timeWindowFilterItem" style="display: none;">
                <label>Time Window</label>
                <select id="timeWindow">
                    <option value="24h">Last 24 hours</option>
                    <option value="7d">Last 7 days</option>
                    <option value="30d">Last 30 days</option>
                </select>
            </div>
            
            <!-- Refresh Button -->
            <button class="refresh-btn" onclick="refreshData()">
                ðŸ”„ Refresh
            </button>
        </div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <h2>ðŸŽ® Analytics Dashboard</h2>
            
            <div class="nav-section">
                <h3>Navigation</h3>
                <button class="nav-button active" onclick="loadSection('live-streams')">
                    ðŸ“º Live Streams
                </button>
                <button class="nav-button" onclick="loadSection('most-active')">
                    ðŸ”¥ Most Active
                </button>
                <button class="nav-button" onclick="loadSection('search')">
                    ï¿½ Search Streams
                </button>
                <button class="nav-button" onclick="loadSection('channel-history')">
                    ðŸ“Š Channel History
                </button>
                <button class="nav-button" onclick="loadSection('categories')">
                    ðŸŽ¯ Categories
                </button>
            </div>
            
            <div class="nav-section">
                <h3>Actions</h3>
                <button class="nav-button" onclick="exportData()">
                    ðŸ“‹ Export CSV
                </button>
                <button class="nav-button" onclick="collectData()">
                    ðŸ”„ Collect Data
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="header">
                <h1 id="pageTitle">Live Streams</h1>
                <div class="breadcrumb" id="breadcrumb">Dashboard > Live Streams</div>
            </div>
            
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title" id="sectionTitle">Live Streams</h2>
                </div>
                <div id="content">
                    <div class="loading">Loading data...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSection = 'live-streams';
        let currentData = [];
        let currentSort = { column: '', direction: 'asc' };
        let historyChart = null;
        
        // Show/hide filter bar based on section
        function showFilterBar(filtersToShow = []) {
            const topFilters = document.getElementById('topFilters');
            const allFilterItems = [
                'limitFilterItem',
                'sortFilterItem', 
                'searchFilterItem',
                'channelFilterItem',
                'timeWindowFilterItem'
            ];
            
            // Hide all optional filters first
            allFilterItems.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
            
            // Show requested filters
            filtersToShow.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) element.style.display = 'flex';
            });
            
            // Show the filter bar
            topFilters.classList.add('show');
        }
        
        function hideFilterBar() {
            document.getElementById('topFilters').classList.remove('show');
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadSection('live-streams');
            
            // Add event listeners for filters
            document.getElementById('platformFilter').addEventListener('change', refreshData);
            document.getElementById('limitFilter').addEventListener('change', refreshData);
            document.getElementById('sortFilter').addEventListener('change', refreshData);
            document.getElementById('searchQuery').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            document.getElementById('channelInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') loadChannelHistory();
            });
            document.getElementById('timeWindow').addEventListener('change', function() {
                if (currentSection === 'channel-history') loadChannelHistory();
            });
        });

        function loadSection(section) {
            // Update active button - find the clicked button
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            
            // Find and activate the button that was clicked
            const buttons = document.querySelectorAll('.nav-button');
            buttons.forEach(btn => {
                if (btn.textContent.includes('Live Streams') && section === 'live-streams') btn.classList.add('active');
                if (btn.textContent.includes('Most Active') && section === 'most-active') btn.classList.add('active');
                if (btn.textContent.includes('Search Streams') && section === 'search') btn.classList.add('active');
                if (btn.textContent.includes('Channel History') && section === 'channel-history') btn.classList.add('active');
                if (btn.textContent.includes('Categories') && section === 'categories') btn.classList.add('active');
            });
            
            currentSection = section;
            
            // Show/hide relevant filter groups
            document.getElementById('searchGroup').style.display = section === 'search' ? 'block' : 'none';
            document.getElementById('channelGroup').style.display = section === 'channel-history' ? 'block' : 'none';
            document.getElementById('timeWindowGroup').style.display = ['most-active', 'channel-history', 'categories'].includes(section) ? 'block' : 'none';
            
            // Update page title and breadcrumb
            const titles = {
                'live-streams': 'Live Streams',
                'most-active': 'Most Active Streamers',
                'search': 'Search Streams',
                'channel-history': 'Channel History',
                'categories': 'Categories & Games'
            };
            
            document.getElementById('pageTitle').textContent = titles[section];
            document.getElementById('breadcrumb').textContent = `Dashboard > ${titles[section]}`;
            document.getElementById('sectionTitle').textContent = titles[section];
            
            refreshData();
        }

        async function refreshData() {
            const platform = document.getElementById('platformFilter').value;
            const limit = document.getElementById('limitFilter').value;
            const sortBy = document.getElementById('sortFilter').value;
            
            document.getElementById('content').innerHTML = '<div class="loading">Loading data...</div>';
            
            try {
                let data;
                
                switch(currentSection) {
                    case 'live-streams':
                        data = await fetchLiveStreams(platform, limit, sortBy);
                        displayStreamsTable(data, 'Live Streams');
                        break;
                        
                    case 'most-active':
                        const mostActiveTimeWindow = document.getElementById('timeWindow').value;
                        data = await fetchMostActive(platform, limit, mostActiveTimeWindow);
                        displayMostActiveTable(data, 'Most Active Streamers');
                        break;
                        
                    case 'search':
                        const query = document.getElementById('searchQuery').value;
                        if (query) {
                            data = await fetchSearch(platform, query, limit);
                            displayStreamsTable(data, `Search Results for "${query}"`);
                        } else {
                            document.getElementById('content').innerHTML = '<div class="no-data">Enter a search term to see results</div>';
                        }
                        break;
                        
                    case 'channel-history':
                        const channelId = document.getElementById('channelInput').value;
                        if (channelId) {
                            const channelTimeWindow = document.getElementById('timeWindow').value;
                            data = await fetchChannelHistory(platform, channelId, channelTimeWindow);
                            displayChannelHistory(data, channelId);
                        } else {
                            document.getElementById('content').innerHTML = '<div class="no-data">Enter a channel ID or username to see history</div>';
                        }
                        break;
                        
                    case 'categories':
                        const categoriesTimeWindow = document.getElementById('timeWindow').value;
                        data = await fetchCategories(platform, categoriesTimeWindow, limit);
                        displayCategoriesTable(data, 'Popular Categories');
                        break;
                }
            } catch (error) {
                document.getElementById('content').innerHTML = `<div class="no-data">Error loading data: ${error.message}</div>`;
            }
        }

        // API Functions
        async function fetchLiveStreams(platform, limit, sortBy) {
            const response = await fetch(`${API_BASE}/live/top?platform=${platform}&limit=${limit}&sort_by=${sortBy}`);
            if (!response.ok) throw new Error('Failed to fetch live streams');
            return await response.json();
        }

        async function fetchMostActive(platform, limit, timeWindow) {
            try {
                const response = await fetch(`${API_BASE}/live/most-active?platform=${platform}&limit=${limit}&window=${timeWindow}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        return []; // Return empty array if endpoint not found
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.warn('Most active endpoint not available, returning empty data');
                return [];
            }
        }

        async function fetchSearch(platform, query, limit) {
            const response = await fetch(`${API_BASE}/search?platform=${platform}&q=${encodeURIComponent(query)}&limit=${limit}`);
            if (!response.ok) throw new Error('Failed to search streams');
            return await response.json();
        }

        async function fetchChannelHistory(platform, channelId, timeWindow) {
            try {
                const response = await fetch(`${API_BASE}/channel/${platform}/${encodeURIComponent(channelId)}/history?window=${timeWindow}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        return { snapshots: [], total_snapshots: 0, avg_viewer_count: 0, peak_viewer_count: 0 };
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.warn('Channel history endpoint not available');
                return { snapshots: [], total_snapshots: 0, avg_viewer_count: 0, peak_viewer_count: 0 };
            }
        }

        async function fetchCategories(platform, timeWindow, limit) {
            try {
                const response = await fetch(`${API_BASE}/stats/categories?platform=${platform}&window=${timeWindow}&limit=${limit}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        return [];
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.warn('Categories endpoint not available');
                return [];
            }
        }

        // Display Functions
        function displayStreamsTable(streams, title) {
            if (!streams || streams.length === 0) {
                document.getElementById('content').innerHTML = '<div class="no-data">No streams found</div>';
                return;
            }

            currentData = streams;
            
            const html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('platform')">Platform</th>
                                <th class="sortable" onclick="sortTable('display_name')">Streamer</th>
                                <th class="sortable" onclick="sortTable('title')">Title</th>
                                <th class="sortable" onclick="sortTable('game_name')">Game</th>
                                <th class="sortable" onclick="sortTable('viewer_count')">Viewers</th>
                                <th class="sortable" onclick="sortTable('follower_count')">Followers</th>
                                <th>Link</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${streams.map(stream => `
                                <tr>
                                    <td><span class="platform-badge platform-${stream.platform}">${stream.platform}</span></td>
                                    <td>${stream.display_name || stream.username}</td>
                                    <td>${stream.title || 'No title'}</td>
                                    <td>${stream.game_name || 'No category'}</td>
                                    <td class="viewer-count">${(stream.viewer_count || 0).toLocaleString()}</td>
                                    <td class="follower-count">${(stream.follower_count || 0).toLocaleString()}</td>
                                    <td><a href="${stream.stream_url || '#'}" target="_blank" class="stream-link">Watch</a></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
        }

        function displayMostActiveTable(streamers, title) {
            if (!streamers || streamers.length === 0) {
                document.getElementById('content').innerHTML = '<div class="no-data">No data found</div>';
                return;
            }

            currentData = streamers;
            
            const html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('username')">Streamer</th>
                                <th class="sortable" onclick="sortTable('stream_count')">Sessions</th>
                                <th class="sortable" onclick="sortTable('total_snapshots')">Total Snapshots</th>
                                <th class="sortable" onclick="sortTable('avg_viewers')">Avg Viewers</th>
                                <th class="sortable" onclick="sortTable('peak_viewers')">Peak Viewers</th>
                                <th class="sortable" onclick="sortTable('last_seen')">Last Seen</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${streamers.map(streamer => `
                                <tr>
                                    <td>${streamer.display_name || streamer.username}</td>
                                    <td>${streamer.stream_count || 0}</td>
                                    <td>${streamer.total_snapshots || 0}</td>
                                    <td class="viewer-count">${Math.round(streamer.avg_viewers || 0).toLocaleString()}</td>
                                    <td class="viewer-count">${(streamer.peak_viewers || 0).toLocaleString()}</td>
                                    <td>${streamer.last_seen ? new Date(streamer.last_seen).toLocaleDateString() : 'Unknown'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
        }

        function displayChannelHistory(data, channelId) {
            if (!data || !data.snapshots || data.snapshots.length === 0) {
                document.getElementById('content').innerHTML = '<div class="no-data">No history found for this channel</div>';
                return;
            }

            const { channel, snapshots, total_snapshots, avg_viewer_count, peak_viewer_count } = data;
            
            const html = `
                <div style="padding: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3>${channel.display_name || channel.username}</h3>
                        <p><strong>Platform:</strong> <span class="platform-badge platform-${channel.platform}">${channel.platform}</span></p>
                        <p><strong>Total Snapshots:</strong> ${total_snapshots}</p>
                        <p><strong>Average Viewers:</strong> ${Math.round(avg_viewer_count).toLocaleString()}</p>
                        <p><strong>Peak Viewers:</strong> ${peak_viewer_count.toLocaleString()}</p>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Title</th>
                                    <th>Game</th>
                                    <th>Viewers</th>
                                    <th>Started At</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${snapshots.map(snapshot => `
                                    <tr>
                                        <td>${new Date(snapshot.collected_at).toLocaleDateString()}</td>
                                        <td>${snapshot.title || 'No title'}</td>
                                        <td>${snapshot.game_name || 'No category'}</td>
                                        <td class="viewer-count">${(snapshot.viewer_count || 0).toLocaleString()}</td>
                                        <td>${snapshot.started_at ? new Date(snapshot.started_at).toLocaleString() : 'Unknown'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
        }

        function displayCategoriesTable(categories, title) {
            if (!categories || categories.length === 0) {
                document.getElementById('content').innerHTML = '<div class="no-data">No categories found</div>';
                return;
            }

            currentData = categories;
            
            const html = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTable('game_name')">Game/Category</th>
                                <th class="sortable" onclick="sortTable('total_streams')">Total Streams</th>
                                <th class="sortable" onclick="sortTable('total_viewers')">Total Viewers</th>
                                <th class="sortable" onclick="sortTable('avg_viewers')">Avg Viewers</th>
                                <th class="sortable" onclick="sortTable('peak_viewers')">Peak Viewers</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${categories.map(category => `
                                <tr>
                                    <td>${category.game_name}</td>
                                    <td>${category.total_streams.toLocaleString()}</td>
                                    <td class="viewer-count">${category.total_viewers.toLocaleString()}</td>
                                    <td class="viewer-count">${Math.round(category.avg_viewers).toLocaleString()}</td>
                                    <td class="viewer-count">${category.peak_viewers.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
        }

        // Table sorting
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('.data-table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const currentTh = event.target;
            currentTh.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Sort data
            currentData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle different data types
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal ? bVal.toLowerCase() : '';
                }
                
                if (typeof aVal === 'number') {
                    return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                } else {
                    return currentSort.direction === 'asc' 
                        ? aVal.localeCompare(bVal)
                        : bVal.localeCompare(aVal);
                }
            });
            
            // Re-render with sorted data
            if (currentSection === 'live-streams' || currentSection === 'search') {
                displayStreamsTable(currentData, '');
            } else if (currentSection === 'most-active') {
                displayMostActiveTable(currentData, '');
            } else if (currentSection === 'categories') {
                displayCategoriesTable(currentData, '');
            }
        }

        async function exportData() {
            try {
                const platform = document.getElementById('platformFilter').value;
                const timeWindow = document.getElementById('timeWindow').value || '24h';
                
                const response = await fetch(`${API_BASE}/export/csv?platform=${platform}&window=${timeWindow}`);
                if (!response.ok) throw new Error('Failed to export data');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `streaming_data_${platform}_${timeWindow}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error exporting data: ' + error.message);
            }
        }

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>